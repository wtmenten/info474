<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Assignment4</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">

</head>
<body>

    <div class="container-fluid d3-container ">
        <div class="row chart-row">
            <div class="nav-container col-md-12">
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#multi-line" role="tab">Multi-line</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#pcoords" role="tab">P Coords</a>
                  </li>
                  <li class="nav-item hidden-sm-up">
                    <a class="nav-link" href="#legend">Legend</a>
                  </li>
                </ul>
            </div>
            <div id="chartTabs" class="tab-content col-md-9">
                <div class="chart-container tab-pane fade show active col-md-12" id="multi-line" role="tabpanel"></div>
                <div class="pc-container tab-pane fade col-md-12" id="pcoords" role="tabpanel"></div>
            </div>
            <div class="col-md-3">
                <h2>Legend</h2>
                <div id='legend' class="legend-container"></div>
            </div>

        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="featureFunctions.js"></script>
    <script src="linegraph.js"></script>
    <script src="pcoords.js"></script>

    <script>
    var initialSource;
    $(function(){
        $('#chartTabs a').click(function (e) {
          e.preventDefault()
          $(this).tab('show')
        })
        d3.csv("dataframe.csv", function(error, source) {
            initialSource = source;
            drawLegend(source);
//            initLineChart(source);
        });

    }); // end document ready


        function drawLegend(data) {
            var legendwidth = $(".legend-container").width();
//            console.log(d3.keys(data[0]));
//            console.log(data);
            var legendState = {};
            d3.keys(data[0]).map(function (d,i) {
                var initConditions = d=="Date" || i == 1;
                legendState[d] = initConditions ? true : null;
            });

            var featureSet = d3.keys(data[0]).filter(function(key) { return key !== "Date"; }).map(function(name) {
              return {
                name: name,
                values: data.map(function(d) {
                  return {date: +d.Date, val: +d[name]};
                })
              };
            });

            var groupedFeatures = groupFeatures.byDomain(featureSet);
            console.log(groupedFeatures);

            color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Date"; }));

            var inputGroup = d3.select(".legend-container").selectAll('.form-check').data(d3.keys(data[0]).filter(function(d){return d!= "Date"}))
                .enter()
                    .append('div')
                    .attr('class', 'form-check clearfix')
                    .attr('value', function (d) {return d;})
                    .on('click', function(){ // makes the whole element toggleable
                        var btn = d3.select(this).select('.filter-button');
                        btn.attr('checked', function (d, i) {return btn.attr('checked') ? null :true});
                        btn.dispatch('change');
                    });

            inputGroup.append('div').attr('class', 'color-marker').style('background-color',function(d){
                return color(d);
            });

            inputGroup.append('input')
                    .attr('type', 'checkbox')
                    .attr('class', 'filter-button clearfix')
                    .attr('value', function (d) {return d;})
                    .attr('checked', function (d, i) {return legendState[d];})
                    .on("change", function() {
                        // console.log('saw filter change');
                        // console.log(legendState);
                        legendState[this.value] = this.checked ? true : null;


                        var activeColumns = d3.keys(data[0]).filter(function(key) {
                            if (key == this.value) {
                                return this.checked ? true : null;
                            } else {
                                return legendState[key];
                            }
                        });
                        var filteredData = [];
                        // console.log("current selected cols: " + activeColumns.toString());

                        data.map(function(rowObj){
                            var retObj = {};
                            activeColumns.map(function(dataKey) {
                               retObj[dataKey] = rowObj[dataKey];
                            });
                            filteredData.push(retObj);
                        });


                        var featureSet2 = activeColumns.filter(function(col) { return col !== "Date"; }).map(function(name) {
                          return {
                            name: name,
                            values: data.map(function(d) {
                              return {date: +d.Date, val: +d[name]};
                            })
                          };
                        });
                        console.log(featureSet2);
                        var groupedFeatures = groupFeatures.byDomain(featureSet2);
                        console.log(groupedFeatures);


                        drawLineChart(filteredData);
                        drawPcoords(filteredData);

                    });

            inputGroup.append('span').attr('class', 'form-check-label')
                    .text(function (d) {return d;});

            var activeColumns = d3.keys(data[0]).filter(function(key) {
                return legendState[key];
            });
            var filteredData = [];
            data.map(function(rowObj){
                var retObj = {};
                activeColumns.map(function(dataKey) {
                   retObj[dataKey] = rowObj[dataKey];
                });
                filteredData.push(retObj);
            });


            initLineChart(filteredData);
            initPcoords(filteredData);


//            dofilter();
//
//            function doFilter(newVal, newState) {
//
//                var activeColumns = d3.keys(data[0]).filter(function(key) { return legendState[key] });
//                var filteredData = [];
//                console.log(activeColumns);
//                data.map(function(rowObj){
//                    var retObj = {};
//                    activeColumns.map(function(dataKey) {
//                       retObj[dataKey] = rowObj[dataKey];
//                    });
//                    filteredData.push(retObj);
//                });
//
//                updateLineChart(filteredData);
//
//            }
        }

    </script>
</body>
</html>